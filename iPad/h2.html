// LesMills Song Search
// https://github.com/osubera/lesmills-song-search

var go = (function(){

/*############################
DOM helpers
############################*/

  function showCriteria1Message(msg) {
    document.getElementById("criteria1").innerText = msg;
  }
  
  function showCriteria2Message(msg) {
    document.getElementById("criteria2").innerText = msg;
  }
  
  function clearCriteriaMessages() {
    showCriteria1Message("");
    showCriteria2Message("");
  }
  
  function showFileNameMessage(msg) {
    document.getElementById("filename").innerText = msg;
  }
  
  function clearFileNameMessage() {
    showFileNameMessage("");
  }
  
  function showErrorMessage(msg) {
    document.getElementById("error").innerText = msg;
  }
  
  function clearErrorMessage() {
    showErrorMessage("");
  }
  
  function clearResult() {
    document.getElementById("result").innerHTML = "";
  }
  
  function toggleResultHead() {
    var show, hide;
    switch(csm.status) {
      case csm.byChoreo: show = "by-choreo"; hide = "by-order"; break;
      case csm.byOrder: hide = "by-choreo"; show = "by-order"; break;
    }
    if(!show && !hide) {
      document.getElementById("result-head").style.display = "none";
    } else {
      document.getElementById(show).style.display = "inline";
      document.getElementById(hide).style.display = "none";
      document.getElementById("result-head").style.display = "table-header-group";
    }
  }
  
  function toggleSubSelectorsDisabled(disable) {
    document.getElementById("choreo").disabled = disable;
    document.getElementById("order").disabled = disable;
  }

  function getCurrentChoreos() {
    var x = [];
    var o = document.getElementById("choreo").childNodes;
    for(var i=0; i < o.length; i++) {
      x.push(o[i].value);
    };
    return(x.filter(
      function(element, index, array) {return(element != "");}
    ));
  }
  
  function unselectChoreoSelector() {
    document.getElementById("choreo").value = "";
  }
  
  function unselectOrderSelector() {
    document.getElementById("order").value = "";
  }

/*############################
Variables, Constants and helpers
############################*/

  // Current search method
  var csm = {
    none: 0,
    byChoreo: 1,
    byOrder: 2,
    status: 0
  }
  
  function setCurrentSearchMethod(which) {
    csm.status = which;
  }
  
  // Satatic files
  var fileText = "index-text";
  var fileClass = "index-class";
  
  // Text data
  var txt = {};
  
  // Multi-language text data
  function loadTexts() {
    var result = songData[fileText];
    if(!result) { failMessageHandler(fileText); }
    txt = result;  // async load to outer scope
  }
  
  function makeFileName(key, choreo) {
    return("json/" + key + "/" + choreo.toLowerCase().replace(/\W/g, "") + ".txt");
  }
  
  // Keep selector heads
  var optionUnselected = {};
  
  function saveSelectorHeads() {
    optionUnselected = {
      "class": document.getElementById("class").innerHTML, 
      "choreo": document.getElementById("choreo").innerHTML, 
      "order": document.getElementById("order").innerHTML
    };
  }

/*############################
HTML helpers
############################*/

  function makeHtmlOption(value, text) {
    return('<option value="' + value +'">' + text + '</option>');
  }
  
  function makeHtmlTrTd(tds) {
    var tr = "";
    for(var i = 0; i < tds.length; i++) {
      tr = tr + '<td>' + tds[i] + '</td>';
    }
    return('<tr>' + tr +'</tr>');
  }

/*############################
Ajax helpers
############################*/

  // ajax error handler
  function failMessageHandler(key) {
    var msg = txt["nofiles"];
    console.log(msg);
    showErrorMessage(msg);
    showFileNameMessage(key);
  }
  
  // remove option tags from select box
  function resetSelector(selector) {
    document.getElementById(selector).innerHTML = optionUnselected[selector];
  }
  
  function resetChoreoSelector() {
    resetSelector("choreo");
  }
  
  function resetOrderSelector() {
    resetSelector("order");
  }
  
  // initialize option tags in select box
  function setupClassSelector() {
    var result = songData[fileClass];
    if(!result) { failMessageHandler(fileClass); }
    var x = optionUnselected.class;
    for(var i=0; i < result.length; i++) {
      x += makeHtmlOption(result[i].class, result[i].view);
    }
    document.getElementById("class").innerHTML = x;
  }
  
  function setupSubSelector(selector, key, file) {
    setCurrentSearchMethod(csm.none);
    var result = songData[key][file];
    if(!result) { failMessageHandler(key + "/" + file); }
    $.ajax(url, commonParams
    ).done(function(result){
      $.each(result, function(i, val){
        $(selector).append(makeHtmlOption(val, val));
      });
    }).fail(failMessageHandler
    );
  }
  
  function setupChoreoSelector(key) {
    if(key != "") {
      /*
      setupSubSelector("#choreo", "json/" + key + "/index-choreo.txt");
      */
      setCurrentSearchMethod(csm.none);
        var result = songData["bodyattack"].indexchoreo;
        var selector = "#choreo";
        var x = optionUnselected.choreo;
        for(var i=0; i < result.length; i++) {
          x += makeHtmlOption(result[i], result[i]);
        }
        document.getElementById("choreo").innerHTML = x;
        /*
        $.each(result, function(i, val){
          $(selector).append(makeHtmlOption(val, val));
        });
        */
    }
  }
  
  function setupOrderSelector(key) {
    if(key != "") {
      setupSubSelector("#order", "json/" + key + "/index-song.txt");
    }
  }
  
  // generate final song list
  function makeSongList(result) {
    var choreo = this.choreo;
    var order = this.order;
    $.each(result, function(i, val){
      if(csm.status == csm.byOrder) {
        if(val["order"] == order) {
          $("#result").append(makeHtmlTrTd([choreo, val["song"], val["artist"]]));
        }
      } else {  // byChoreo
        $("#result").append(makeHtmlTrTd([val["order"], val["song"], val["artist"]]));
      }
    });
  }
  
  function appendResultTable(key, choreo, order) {
    var filename = makeFileName(key, choreo);
    $.ajax(filename, $.extend({}, commonParams, {
      context: { key: key, choreo: choreo, order: order, url: filename }
      })
    ).done(makeSongList
    ).fail(failMessageHandler
    );
  }
  
  function searchSongsByChoreo(choreo) {
    clearCriteriaMessages();
    clearResult();
    if(choreo != "") {
      setCurrentSearchMethod(csm.byChoreo);
      var key = $("#class").val();
      var view = $("#class option:selected").text();
      showCriteria1Message(view);
      showCriteria2Message(choreo);
      toggleResultHead();
      appendResultTable(key, choreo, "");
    }
  }
  
  function searchSongsByOrder(order) {
    clearCriteriaMessages();
    clearResult();
    if(choreo != "") {
      setCurrentSearchMethod(csm.byOrder);
      var key = $("#class").val();
      var view = $("#class option:selected").text();
      showCriteria1Message(view);
      showCriteria2Message(order);
      toggleResultHead();
      var choreos = getCurrentChoreos();
      for(var i = 0; i < choreos.length; i++) {
        appendResultTable(key, choreos[i], order);
      }
    }
  }

/*############################
Ajax Event hanlers
############################*/

/*
  $("#class").change(function(){
    var selected = $(this).val();
    setCurrentSearchMethod(csm.none);
    toggleResultHead();
    clearResult();
    clearErrorMessage();
    clearFileNameMessage();
    clearCriteriaMessages();
    resetChoreoSelector();
    resetOrderSelector();
    showCriteria1Message(selected);
    setupChoreoSelector(selected);
    setupOrderSelector(selected);
    toggleSubSelectorsDisabled(selected == "");
  });
  
  $("#choreo").change(function(){
    var selected = $(this).val();
    clearErrorMessage();
    clearFileNameMessage();
    unselectOrderSelector();
    searchSongsByChoreo(selected);
  });
  
  $("#order").change(function(){
    var selected = $(this).val();
    clearErrorMessage();
    clearFileNameMessage();
    unselectChoreoSelector();
    searchSongsByOrder(selected);
  });
  
  */
/*############################
Main
############################*/

  loadTexts();
  saveSelectorHeads();
  setupClassSelector();
  console.log("done");

});
  </script>
</head>
<body onload="go()">

<div id="console">
  <header><h1>LesMills</h1></header>
  <form>
    <select id="class" name="class">
      <option selected="selected" value="">種目を選ぶ ▼</option>
    </select>
    <select id="choreo" name="choreo">
      <option selected="selected" value="">コリオ番号を選ぶ ▼</option>
    </select>
    <select id="order" name="order">
      <option selected="selected" value="">曲順を選ぶ ▼</option>
    </select>
  </form>
  <div id="error"></div>
  <div id="filename"></div>
</div>

<div id="fixed-console-spacer"></div>

<main>
  <header><h2 id="criteria1"></h2><h3 id="criteria2"></h3></header>
  <table>
    <thead id="result-head">
      <tr>
        <th>
          <span  id="by-order">コリオ番号</span>
          <span id="by-choreo">曲順</span></th>
        <th>曲名</th>
        <th>アーティスト名</th>
      </tr>
    </thead>
    <tbody id="result"></tbody>
  </table>
</main>

<div id="fixed-footer-spacer"></div>

<footer><span><a href="https://github.com/osubera/lesmills-song-search">sources are available at github. </a></span></footer>
</body>
</html>